@using BsBios.Portal.UI.Helpers
@using BsBios.Portal.ViewModel
@model CotacaoFreteCadastroVm

@{
    ViewBag.TituloDaPagina = "Cotação de Frete";
}
<div class="paginaCadastro">
    @using (Html.BeginForm())
    {
        @Html.HiddenFor(model => model.IdProcessoCotacao)
        @Html.HiddenFor(model => model.CodigoFornecedor)

        Html.RenderPartial("_CabecalhoDoProcessoDeCotacaoDeFrete", Model.Cabecalho);        
       
        <fieldset>
            <legend>Cotação do Fornecedor</legend>
            @{
                string classe = "maskmoeda";
                object atributos;
                if (Model.PermiteAlterarPreco)
                {
                    atributos = new
                    {
                        @class = classe
                    };
                }
                else
                {
                    classe += " campoDesabilitado";
                    atributos = new
                    {
                        @readonly = true,
                        @class = classe
                    };
                }
            }
            @Html.LinhaComDuasColunas(new ColunaComTextBox<CotacaoFreteCadastroVm, decimal?>(x => x.ValorComImpostos, atributos),
                                      new ColunaComTextBox<CotacaoFreteCadastroVm, decimal?>(x => x.QuantidadeDisponivel,"maskquantidade"))
            
            @Html.LinhaComUmaColuna(new ColunaComTextArea<CotacaoFreteCadastroVm, string>(x => x.ObservacoesDoFornecedor))

        </fieldset>
        
  
        <div class="error">
            @if (ViewData["erro"] != null)
            {
                @ViewData["erro"]
            }
        </div>
        
        @Html.ValidationSummary(true)

        <div class="divBotao">
            <input type="button" id="btnAceitarCotacao" value="Aceitar" class="blue" />
            <input type="button" id="btnRecusarCotacao" value="Recusar" class="blue" />
            <a href="@Url.Action("Index","ProcessoDeCotacaoDeFrete")" class="blue">Sair</a>
        </div>
    }
</div>
@section scripts
{
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/scriptsgerais")
    <script src="@Url.Content("~/Scripts/jquery.meio.mask.js")"></script>
    <script type="text/javascript">
       
        $(function () {
            aplicaMascaraQuantidade();
            aplicaMascaraMoeda();

            function atualizaMensagemDeErro(mensagem) {
                $('.error').html(mensagem);
            }

            $('#btnAceitarCotacao').click(function() {
                $('.error').empty();
                var form = $('form');
                if (!$(form).validate().form()) {
                    return;
                }

                var formData = $(form).serialize();
                $.post('@Url.Action("Salvar", "CotacaoDeFreteAtualizar")', formData,
                    function(data) {
                        if (data.Sucesso) {
                            location.href = '@Url.Action("Index", "ProcessoDeCotacaoDeFrete")';
                        } else {
                            atualizaMensagemDeErro(data.Mensagem);
                        }
                    });

            });

            $('#btnRecusarCotacao').click(function() {
                Mensagem.ExibirMensagemDeConfirmacao('Tem certeza que deseja Recusar a Cotação?', function() {
                    $.ajax({
                        url: '@Url.Action("SairDoProcesso","CotacaoDeFreteAtualizar")',
                        type: 'POST',
                        contentType: "application/json; charset=utf-8",
                        dataType: 'json',

                        data: JSON.stringify({
                            IdDoProcessoDeCotacao: $('#IdProcessoCotacao').val(),
                            CodigoDoFornecedor: $('#CodigoFornecedor').val()
                        })
                    })
                    .done(function (data) {
                        if (data.Sucesso) {
                            location.href = '@Url.Action("Index", "ProcessoDeCotacaoDeFrete")';
                        } else {
                            Mensagem.ExibirMensagemDeErro(data.Mensagem);
                        }
                    })
                    .fail(function () {
                        Mensagem.ExibirMensagemDeErro('Ocorreu um erro ao recusar o Processo de Cotação');
                    });
                });
            });
        });
    </script>
}

